alias gs="git status"

gbackup() {
  local branch
  local timestamp
  branch=$(git rev-parse --abbrev-ref HEAD)
  timestamp=$(date +%Y%m%d%H%M%S)
  
  git fetch origin
  git checkout "$branch"
  git branch "backup/${branch}-${timestamp}"
  echo "âœ” Backup criado: backup/${branch}-${timestamp}"
}

gsquash() {
  local branch base commit_count msg
  
  # Verificar estado limpo
  if ! git diff-index --quiet HEAD --; then
    echo "âŒ HÃ¡ mudanÃ§as nÃ£o commitadas. Commit ou stash antes."
    return 1
  fi
  
  branch=$(git branch --show-current)
  
  # ğŸ”’ SeguranÃ§a: branches protegidas
  case "$branch" in
    main|master|develop|development|dev|stage|staging|release* )
      echo "âŒ Squash bloqueado na branch protegida: $branch"
      return 1
      ;;
  esac
  
  # ğŸ¯ APENAS upstream - sem heurÃ­stica
  base="$(git rev-parse --abbrev-ref --symbolic-full-name @{upstream} 2>/dev/null)"
  
  if [ -z "$base" ]; then
    echo "âŒ Branch sem upstream configurado."
    echo ""
    echo "Configure o upstream primeiro:"
    echo "  git branch --set-upstream-to=origin/main"
    echo "  ou"
    echo "  git push -u origin $branch"
    return 1
  fi
  
  # Contar commits a serem squashados
  commit_count=$(git rev-list --count "$base..HEAD")
  
  if [ "$commit_count" -eq 0 ]; then
    echo "âš ï¸  Nenhum commit novo em relaÃ§Ã£o a $base"
    return 0
  fi
  
  if [ "$commit_count" -eq 1 ]; then
    echo "â„¹ï¸  Apenas 1 commit. Nada para squashar."
    return 0
  fi
  
  echo "âœ”ï¸  Base (upstream): $base"
  echo "ğŸ“¦ $commit_count commits serÃ£o consolidados em 1"
  echo ""
  
  # Mostrar preview dos commits
  echo "Commits que serÃ£o squashados:"
  git log --oneline "$base..HEAD"
  echo ""
  
  # Confirmar operaÃ§Ã£o
  read -p "ğŸ¤” Continuar? [y/N] " -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "âŒ OperaÃ§Ã£o cancelada"
    return 1
  fi
  
  # ğŸ›Ÿ Criar backup
  echo "ğŸ’¾ Criando backup..."
  gbackup || return 1
  
  # ğŸ”¥ Fazer o squash
  echo "ğŸ”„ Fazendo squash..."
  git fetch origin
  
  # Capturar mensagens dos commits para referÃªncia
  msg=$(git log --format='- %s' "$base..HEAD")
  
  git reset --soft "$base"
  
  # Commit com editor para ajustar mensagem
  git commit -e -m "squash: consolidados $commit_count commits

    Commits originais:
    $msg
    " || return 1
  
  echo ""
  echo "âœ… Squash local concluÃ­do!"
  echo ""
  
  # Perguntar sobre push
  read -p "ğŸš€ Fazer push --force-with-lease agora? [y/N] " -n 1 -r
  echo
  
  if [[ $REPLY =~ ^[Yy]$ ]]; then
    git push --force-with-lease origin "$branch" || return 1
    echo "ğŸ‰ Squash e push concluÃ­dos com sucesso!"
  else
    echo "ğŸ’¡ Para fazer push depois: git push --force-with-lease origin $branch"
  fi
  
  echo ""
  echo "ğŸ“Š Resumo: $commit_count commits â†’ 1 commit"
}